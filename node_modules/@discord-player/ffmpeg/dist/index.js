"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// src/index.ts
var src_exports = {};
__export(src_exports, {
  FFmpeg: () => FFmpeg,
  FFmpegPossibleLocations: () => FFmpegPossibleLocations,
  findFFmpeg: () => findFFmpeg,
  version: () => version
});
module.exports = __toCommonJS(src_exports);

// src/FFmpeg.ts
var import_child_process = __toESM(require("child_process"));
var import_stream = require("stream");
var validatePathParam = /* @__PURE__ */ __name((t, name) => {
  if (typeof t !== "string" || !t)
    throw new TypeError(`Expected ${name ? name.concat(" to be ") : ""}a string, got ${t}`);
  return t;
}, "validatePathParam");
var ffmpegInfo = {
  command: null,
  metadata: null,
  version: null,
  isStatic: false
};
var isWindows = process.platform === "win32";
var FFmpegPossibleLocations = [
  {
    getPath() {
      return validatePathParam(process.env.FFMPEG_PATH, this.displayName);
    },
    displayName: "spawn process.env.FFMPEG_PATH"
  },
  {
    getPath() {
      return "ffmpeg";
    },
    displayName: "spawn ffmpeg"
  },
  {
    getPath() {
      return "avconv";
    },
    displayName: "spawn avconv"
  },
  {
    getPath() {
      const loc = "./ffmpeg";
      if (isWindows)
        return loc.concat(".exe");
      return loc;
    },
    displayName: "spawn ./ffmpeg"
  },
  {
    getPath() {
      const loc = "./avconv";
      if (isWindows)
        return loc.concat(".exe");
      return loc;
    },
    displayName: "spawn ./avconv"
  },
  {
    getPath() {
      const mod = require("@ffmpeg-installer/ffmpeg");
      return validatePathParam(mod.default?.path || mod.path || mod, this.displayName);
    },
    displayName: 'require("@ffmpeg-installer/ffmpeg")'
  },
  {
    getPath() {
      const mod = require("ffmpeg-static");
      return validatePathParam(mod.default?.path || mod.path || mod, this.displayName);
    },
    displayName: 'require("ffmpeg-static")'
  },
  {
    getPath() {
      const mod = require("@node-ffmpeg/node-ffmpeg-installer");
      return validatePathParam(mod.default?.path || mod.path || mod, this.displayName);
    },
    displayName: 'require("@node-ffmpeg/node-ffmpeg-installer")'
  },
  {
    getPath() {
      const mod = require("ffmpeg-binaries");
      return validatePathParam(mod.default || mod, this.displayName);
    },
    displayName: 'require("ffmpeg-binaries")'
  }
];
var _FFmpeg = class extends import_stream.Duplex {
  constructor(options = {}) {
    super(options);
    this.process = _FFmpeg.spawn(options);
    const EVENTS = {
      readable: this._reader,
      data: this._reader,
      end: this._reader,
      unpipe: this._reader,
      finish: this._writer,
      drain: this._writer
    };
    this._readableState = this._reader._readableState;
    this._writableState = this._writer._writableState;
    this._copy(["write", "end"], this._writer);
    this._copy(["read", "setEncoding", "pipe", "unpipe"], this._reader);
    for (const method of ["on", "once", "removeListener", "removeAllListeners", "listeners"]) {
      this[method] = (ev, fn) => EVENTS[ev] ? EVENTS[ev][method](ev, fn) : import_stream.Duplex.prototype[method].call(this, ev, fn);
    }
    const processError = /* @__PURE__ */ __name((error) => this.emit("error", error), "processError");
    this._reader.on("error", processError);
    this._writer.on("error", processError);
  }
  static spawn({ args = [], shell = false } = {}) {
    if (!args.includes("-i"))
      args.unshift("-i", "-");
    return import_child_process.default.spawn(this.locate().command, args.concat(["pipe:1"]), { windowsHide: true, shell });
  }
  static isAvailable() {
    return typeof this.locateSafe(false)?.command === "string";
  }
  static locateSafe(force = false) {
    try {
      return this.locate(force);
    } catch {
      return null;
    }
  }
  static locate(force = false) {
    if (ffmpegInfo.command && !force)
      return ffmpegInfo;
    const errStacks = new Array(FFmpegPossibleLocations.length);
    for (const locator of FFmpegPossibleLocations) {
      if (locator == null)
        continue;
      try {
        const command = locator.getPath();
        const result = import_child_process.default.spawnSync(command, ["-h"], {
          windowsHide: true
        });
        if (result.error)
          throw result.error;
        ffmpegInfo.command = command;
        ffmpegInfo.metadata = Buffer.concat(result.output.filter(Boolean)).toString();
        ffmpegInfo.isStatic = locator.displayName.startsWith('require("');
        ffmpegInfo.version = _FFmpeg.VersionRegex.exec(ffmpegInfo.metadata || "")?.[1] || null;
        return ffmpegInfo;
      } catch (e) {
        errStacks.push(e);
      }
    }
    throw new Error([
      "Could not locate ffmpeg. Tried:\n",
      ...FFmpegPossibleLocations.map((loc, i) => `  ${++i}. ${loc.displayName}`),
      "\n",
      `${"=".repeat(5)}Full Stacktrace${"=".repeat(5)}`,
      ...errStacks.map((e) => e.stack || e.message)
    ].join("\n"));
  }
  get _reader() {
    return this.process.stdout;
  }
  get _writer() {
    return this.process.stdin;
  }
  _copy(methods, target) {
    for (const method of methods) {
      this[method] = target[method].bind(target);
    }
  }
  _destroy(err, cb) {
    this._cleanup();
    if (cb)
      return cb(err);
  }
  _final(cb) {
    this._cleanup();
    cb();
  }
  _cleanup() {
    if (this.process) {
      this.once("error", () => {
      });
      this.process.kill("SIGKILL");
      this.process = null;
    }
  }
  toString() {
    if (!ffmpegInfo.metadata)
      return "FFmpeg";
    return ffmpegInfo.metadata;
  }
};
var FFmpeg = _FFmpeg;
__name(FFmpeg, "FFmpeg");
FFmpeg.VersionRegex = /version (.+) Copyright/im;
var findFFmpeg = FFmpeg.locate;

// src/index.ts
var version = "0.1.0";
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  FFmpeg,
  FFmpegPossibleLocations,
  findFFmpeg,
  version
});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL2luZGV4LnRzIiwgIi4uL3NyYy9GRm1wZWcudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImV4cG9ydCAqIGZyb20gJy4vRkZtcGVnJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1pbmZlcnJhYmxlLXR5cGVzXG5leHBvcnQgY29uc3QgdmVyc2lvbjogc3RyaW5nID0gJzAuMS4wJztcbiIsICJpbXBvcnQgY2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgRHVwbGV4LCBEdXBsZXhPcHRpb25zIH0gZnJvbSAnc3RyZWFtJztcblxudHlwZSBDYWxsYmFjazxBcmdzIGV4dGVuZHMgQXJyYXk8dW5rbm93bj4+ID0gKC4uLmFyZ3M6IEFyZ3MpID0+IHVua25vd247XG5cbmNvbnN0IHZhbGlkYXRlUGF0aFBhcmFtID0gKHQ6IHVua25vd24sIG5hbWU/OiBzdHJpbmcpID0+IHtcbiAgICBpZiAodHlwZW9mIHQgIT09ICdzdHJpbmcnIHx8ICF0KSB0aHJvdyBuZXcgVHlwZUVycm9yKGBFeHBlY3RlZCAke25hbWUgPyBuYW1lLmNvbmNhdCgnIHRvIGJlICcpIDogJyd9YSBzdHJpbmcsIGdvdCAke3R9YCk7XG4gICAgcmV0dXJuIHQ7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEZGbXBlZ0luZm8ge1xuICAgIGNvbW1hbmQ6IHN0cmluZyB8IG51bGw7XG4gICAgbWV0YWRhdGE6IHN0cmluZyB8IG51bGw7XG4gICAgdmVyc2lvbjogc3RyaW5nIHwgbnVsbDtcbiAgICBpc1N0YXRpYzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGRm1wZWdPcHRpb25zIGV4dGVuZHMgRHVwbGV4T3B0aW9ucyB7XG4gICAgYXJncz86IHN0cmluZ1tdO1xuICAgIHNoZWxsPzogYm9vbGVhbjtcbn1cblxuY29uc3QgZmZtcGVnSW5mbzogRkZtcGVnSW5mbyA9IHtcbiAgICBjb21tYW5kOiBudWxsLFxuICAgIG1ldGFkYXRhOiBudWxsLFxuICAgIHZlcnNpb246IG51bGwsXG4gICAgaXNTdGF0aWM6IGZhbHNlXG59O1xuXG5pbnRlcmZhY2UgRkZtcGVnTG9jYXRpb24ge1xuICAgIGRpc3BsYXlOYW1lOiBzdHJpbmc7XG4gICAgZ2V0UGF0aDogKCkgPT4gc3RyaW5nO1xufVxuXG5jb25zdCBpc1dpbmRvd3MgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzICovXG4vLyBwcmV0dGllci1pZ25vcmVcbmV4cG9ydCBjb25zdCBGRm1wZWdQb3NzaWJsZUxvY2F0aW9uczogRkZtcGVnTG9jYXRpb25bXSA9IFtcbiAgICB7XG4gICAgICAgIGdldFBhdGgoKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVQYXRoUGFyYW0ocHJvY2Vzcy5lbnYuRkZNUEVHX1BBVEgsIHRoaXMuZGlzcGxheU5hbWUpO1xuICAgICAgICB9LFxuICAgICAgICBkaXNwbGF5TmFtZTogJ3NwYXduIHByb2Nlc3MuZW52LkZGTVBFR19QQVRIJ1xuICAgIH0sXG4gICAge1xuICAgICAgICBnZXRQYXRoKCkge1xuICAgICAgICAgICAgcmV0dXJuICdmZm1wZWcnO1xuICAgICAgICB9LFxuICAgICAgICBkaXNwbGF5TmFtZTogJ3NwYXduIGZmbXBlZydcbiAgICB9LFxuICAgIHtcbiAgICAgICAgZ2V0UGF0aCgpIHtcbiAgICAgICAgICAgIHJldHVybiAnYXZjb252JztcbiAgICAgICAgfSxcbiAgICAgICAgZGlzcGxheU5hbWU6ICdzcGF3biBhdmNvbnYnXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGdldFBhdGgoKSB7XG4gICAgICAgICAgICBjb25zdCBsb2MgPSAnLi9mZm1wZWcnO1xuICAgICAgICAgICAgaWYgKGlzV2luZG93cykgcmV0dXJuIGxvYy5jb25jYXQoJy5leGUnKTtcbiAgICAgICAgICAgIHJldHVybiBsb2M7XG4gICAgICAgIH0sXG4gICAgICAgIGRpc3BsYXlOYW1lOiAnc3Bhd24gLi9mZm1wZWcnXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGdldFBhdGgoKSB7XG4gICAgICAgICAgICBjb25zdCBsb2MgPSAnLi9hdmNvbnYnO1xuICAgICAgICAgICAgaWYgKGlzV2luZG93cykgcmV0dXJuIGxvYy5jb25jYXQoJy5leGUnKTtcbiAgICAgICAgICAgIHJldHVybiBsb2M7XG4gICAgICAgIH0sXG4gICAgICAgIGRpc3BsYXlOYW1lOiAnc3Bhd24gLi9hdmNvbnYnXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGdldFBhdGgoKSB7XG4gICAgICAgICAgICBjb25zdCBtb2QgPSByZXF1aXJlKCdAZmZtcGVnLWluc3RhbGxlci9mZm1wZWcnKTtcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZVBhdGhQYXJhbShtb2QuZGVmYXVsdD8ucGF0aCB8fCBtb2QucGF0aCB8fCBtb2QsIHRoaXMuZGlzcGxheU5hbWUpO1xuICAgICAgICB9LFxuICAgICAgICBkaXNwbGF5TmFtZTogJ3JlcXVpcmUoXCJAZmZtcGVnLWluc3RhbGxlci9mZm1wZWdcIiknXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGdldFBhdGgoKSB7XG4gICAgICAgICAgICBjb25zdCBtb2QgPSByZXF1aXJlKCdmZm1wZWctc3RhdGljJyk7XG4gICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVQYXRoUGFyYW0obW9kLmRlZmF1bHQ/LnBhdGggfHwgbW9kLnBhdGggfHwgbW9kLCB0aGlzLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGlzcGxheU5hbWU6ICdyZXF1aXJlKFwiZmZtcGVnLXN0YXRpY1wiKSdcbiAgICB9LFxuICAgIHtcbiAgICAgICAgZ2V0UGF0aCgpIHtcbiAgICAgICAgICAgIGNvbnN0IG1vZCA9IHJlcXVpcmUoJ0Bub2RlLWZmbXBlZy9ub2RlLWZmbXBlZy1pbnN0YWxsZXInKTtcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZVBhdGhQYXJhbShtb2QuZGVmYXVsdD8ucGF0aCB8fCBtb2QucGF0aCB8fCBtb2QsIHRoaXMuZGlzcGxheU5hbWUpO1xuICAgICAgICB9LFxuICAgICAgICBkaXNwbGF5TmFtZTogJ3JlcXVpcmUoXCJAbm9kZS1mZm1wZWcvbm9kZS1mZm1wZWctaW5zdGFsbGVyXCIpJ1xuICAgIH0sXG4gICAge1xuICAgICAgICBnZXRQYXRoKCkge1xuICAgICAgICAgICAgY29uc3QgbW9kID0gcmVxdWlyZSgnZmZtcGVnLWJpbmFyaWVzJyk7XG4gICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVQYXRoUGFyYW0obW9kLmRlZmF1bHQgfHwgbW9kLCB0aGlzLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGlzcGxheU5hbWU6ICdyZXF1aXJlKFwiZmZtcGVnLWJpbmFyaWVzXCIpJ1xuICAgIH1cbl07XG4vKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXMgKi9cblxuZXhwb3J0IGNsYXNzIEZGbXBlZyBleHRlbmRzIER1cGxleCB7XG4gICAgLyoqXG4gICAgICogRkZtcGVnIHZlcnNpb24gcmVnZXhcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIFZlcnNpb25SZWdleCA9IC92ZXJzaW9uICguKykgQ29weXJpZ2h0L2ltO1xuXG4gICAgLyoqXG4gICAgICogU3Bhd25zIGZmbXBlZyBwcm9jZXNzXG4gICAgICogQHBhcmFtIG9wdGlvbnMgU3Bhd24gb3B0aW9uc1xuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgc3Bhd24oeyBhcmdzID0gW10gYXMgc3RyaW5nW10sIHNoZWxsID0gZmFsc2UgfSA9IHt9KSB7XG4gICAgICAgIGlmICghYXJncy5pbmNsdWRlcygnLWknKSkgYXJncy51bnNoaWZ0KCctaScsICctJyk7XG5cbiAgICAgICAgcmV0dXJuIGNoaWxkUHJvY2Vzcy5zcGF3bih0aGlzLmxvY2F0ZSgpIS5jb21tYW5kISwgYXJncy5jb25jYXQoWydwaXBlOjEnXSksIHsgd2luZG93c0hpZGU6IHRydWUsIHNoZWxsIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGZmbXBlZyBpcyBhdmFpbGFibGVcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCkge1xuICAgICAgICByZXR1cm4gdHlwZW9mIHRoaXMubG9jYXRlU2FmZShmYWxzZSk/LmNvbW1hbmQgPT09ICdzdHJpbmcnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhZmUgbG9jYXRlIGZmbXBlZ1xuICAgICAqIEBwYXJhbSBmb3JjZSBpZiBpdCBzaG91bGQgcmVsb2NhdGUgdGhlIGNvbW1hbmRcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGxvY2F0ZVNhZmUoZm9yY2UgPSBmYWxzZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRlKGZvcmNlKTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvY2F0ZSBmZm1wZWcgY29tbWFuZC4gVGhyb3dzIGVycm9yIGlmIGZmbXBlZyBpcyBub3QgZm91bmQuXG4gICAgICogQHBhcmFtIGZvcmNlIEZvcmNlZnVsbHkgcmVsb2FkXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBsb2NhdGUoZm9yY2UgPSBmYWxzZSk6IEZGbXBlZ0luZm8gfCB1bmRlZmluZWQge1xuICAgICAgICBpZiAoZmZtcGVnSW5mby5jb21tYW5kICYmICFmb3JjZSkgcmV0dXJuIGZmbXBlZ0luZm87XG5cbiAgICAgICAgY29uc3QgZXJyU3RhY2tzOiBFcnJvcltdID0gbmV3IEFycmF5KEZGbXBlZ1Bvc3NpYmxlTG9jYXRpb25zLmxlbmd0aCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBsb2NhdG9yIG9mIEZGbXBlZ1Bvc3NpYmxlTG9jYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAobG9jYXRvciA9PSBudWxsKSBjb250aW51ZTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGxvY2F0b3IuZ2V0UGF0aCgpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2hpbGRQcm9jZXNzLnNwYXduU3luYyhjb21tYW5kLCBbJy1oJ10sIHtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93c0hpZGU6IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuZXJyb3IpIHRocm93IHJlc3VsdC5lcnJvcjtcblxuICAgICAgICAgICAgICAgIGZmbXBlZ0luZm8uY29tbWFuZCA9IGNvbW1hbmQ7XG4gICAgICAgICAgICAgICAgZmZtcGVnSW5mby5tZXRhZGF0YSA9IEJ1ZmZlci5jb25jYXQocmVzdWx0Lm91dHB1dC5maWx0ZXIoQm9vbGVhbikgYXMgQnVmZmVyW10pLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgZmZtcGVnSW5mby5pc1N0YXRpYyA9IGxvY2F0b3IuZGlzcGxheU5hbWUuc3RhcnRzV2l0aCgncmVxdWlyZShcIicpO1xuICAgICAgICAgICAgICAgIGZmbXBlZ0luZm8udmVyc2lvbiA9IEZGbXBlZy5WZXJzaW9uUmVnZXguZXhlYyhmZm1wZWdJbmZvLm1ldGFkYXRhIHx8ICcnKT8uWzFdIHx8IG51bGw7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmZtcGVnSW5mbztcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBlcnJTdGFja3MucHVzaChlIGFzIEVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHByZXR0aWVyLWlnbm9yZVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoW1xuICAgICAgICAgICAgJ0NvdWxkIG5vdCBsb2NhdGUgZmZtcGVnLiBUcmllZDpcXG4nLFxuICAgICAgICAgICAgLi4uRkZtcGVnUG9zc2libGVMb2NhdGlvbnMubWFwKChsb2MsIGkpID0+IGAgICR7KytpfS4gJHtsb2MuZGlzcGxheU5hbWV9YCksXG4gICAgICAgICAgICAnXFxuJyxcbiAgICAgICAgICAgIGAkeyc9Jy5yZXBlYXQoNSl9RnVsbCBTdGFja3RyYWNlJHsnPScucmVwZWF0KDUpfWAsXG4gICAgICAgICAgICAuLi5lcnJTdGFja3MubWFwKChlKSA9PiBlLnN0YWNrIHx8IGUubWVzc2FnZSlcbiAgICAgICAgXS5qb2luKCdcXG4nKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3VycmVudCBGRm1wZWcgcHJvY2Vzc1xuICAgICAqL1xuICAgIHB1YmxpYyBwcm9jZXNzOiBjaGlsZFByb2Nlc3MuQ2hpbGRQcm9jZXNzV2l0aG91dE51bGxTdHJlYW1zO1xuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIEZGbXBlZyBkdXBsZXggc3RyZWFtXG4gICAgICogQHBhcmFtIG9wdGlvbnMgT3B0aW9ucyB0byBpbml0aWFsaXplIGZmbXBlZ1xuICAgICAqIEBleGFtcGxlIGBgYHR5cGVzY3JpcHRcbiAgICAgKiBjb25zdCBmZm1wZWcgPSBuZXcgRkZtcGVnKHtcbiAgICAgKiAgIGFyZ3M6IFtcbiAgICAgKiAgICAgJy1hbmFseXplZHVyYXRpb24nLCAnMCcsXG4gICAgICogICAgICctbG9nbGV2ZWwnLCAnMCcsXG4gICAgICogICAgICctZicsICdzMTZsZScsXG4gICAgICogICAgICctYXInLCAnNDgwMDAnLFxuICAgICAqICAgICAnLWFjJywgJzInLFxuICAgICAqICAgICAnLWFmJywgJ2Jhc3M9Zz0xMCxhY29tcHJlc3NvcidcbiAgICAgKiAgIF1cbiAgICAgKiB9KTtcbiAgICAgKlxuICAgICAqIGNvbnN0IHBjbSA9IGlucHV0LnBpcGUoZmZtcGVnKTtcbiAgICAgKlxuICAgICAqIHBjbS5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKCcuL2F1ZGlvLnBjbScpKTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwdWJsaWMgY29uc3RydWN0b3Iob3B0aW9uczogRkZtcGVnT3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKG9wdGlvbnMpO1xuXG4gICAgICAgIHRoaXMucHJvY2VzcyA9IEZGbXBlZy5zcGF3bihvcHRpb25zKTtcblxuICAgICAgICBjb25zdCBFVkVOVFMgPSB7XG4gICAgICAgICAgICByZWFkYWJsZTogdGhpcy5fcmVhZGVyLFxuICAgICAgICAgICAgZGF0YTogdGhpcy5fcmVhZGVyLFxuICAgICAgICAgICAgZW5kOiB0aGlzLl9yZWFkZXIsXG4gICAgICAgICAgICB1bnBpcGU6IHRoaXMuX3JlYWRlcixcbiAgICAgICAgICAgIGZpbmlzaDogdGhpcy5fd3JpdGVyLFxuICAgICAgICAgICAgZHJhaW46IHRoaXMuX3dyaXRlclxuICAgICAgICB9IGFzIGNvbnN0O1xuXG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IHRoaXMuX3JlYWRlci5fcmVhZGFibGVTdGF0ZTtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlID0gdGhpcy5fd3JpdGVyLl93cml0YWJsZVN0YXRlO1xuXG4gICAgICAgIHRoaXMuX2NvcHkoWyd3cml0ZScsICdlbmQnXSwgdGhpcy5fd3JpdGVyKTtcbiAgICAgICAgdGhpcy5fY29weShbJ3JlYWQnLCAnc2V0RW5jb2RpbmcnLCAncGlwZScsICd1bnBpcGUnXSwgdGhpcy5fcmVhZGVyKTtcblxuICAgICAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiBbJ29uJywgJ29uY2UnLCAncmVtb3ZlTGlzdGVuZXInLCAncmVtb3ZlQWxsTGlzdGVuZXJzJywgJ2xpc3RlbmVycyddIGFzIGNvbnN0KSB7XG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICB0aGlzW21ldGhvZF0gPSAoZXYsIGZuKSA9PiAoRVZFTlRTW2V2XSA/IEVWRU5UU1tldl1bbWV0aG9kXShldiwgZm4pIDogRHVwbGV4LnByb3RvdHlwZVttZXRob2RdLmNhbGwodGhpcywgZXYsIGZuKSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcm9jZXNzRXJyb3IgPSAoZXJyb3I6IEVycm9yKSA9PiB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuXG4gICAgICAgIHRoaXMuX3JlYWRlci5vbignZXJyb3InLCBwcm9jZXNzRXJyb3IpO1xuICAgICAgICB0aGlzLl93cml0ZXIub24oJ2Vycm9yJywgcHJvY2Vzc0Vycm9yKTtcbiAgICB9XG5cbiAgICBnZXQgX3JlYWRlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2VzcyEuc3Rkb3V0O1xuICAgIH1cbiAgICBnZXQgX3dyaXRlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2VzcyEuc3RkaW47XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY29weShtZXRob2RzOiBzdHJpbmdbXSwgdGFyZ2V0OiB1bmtub3duKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIG1ldGhvZHMpIHtcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgICAgIHRoaXNbbWV0aG9kXSA9IHRhcmdldFttZXRob2RdLmJpbmQodGFyZ2V0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBfZGVzdHJveShlcnI6IEVycm9yIHwgbnVsbCwgY2I6IENhbGxiYWNrPFtFcnJvciB8IG51bGxdPikge1xuICAgICAgICB0aGlzLl9jbGVhbnVwKCk7XG4gICAgICAgIGlmIChjYikgcmV0dXJuIGNiKGVycik7XG4gICAgfVxuXG4gICAgcHVibGljIF9maW5hbChjYjogQ2FsbGJhY2s8W10+KSB7XG4gICAgICAgIHRoaXMuX2NsZWFudXAoKTtcbiAgICAgICAgY2IoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jbGVhbnVwKCkge1xuICAgICAgICBpZiAodGhpcy5wcm9jZXNzKSB7XG4gICAgICAgICAgICB0aGlzLm9uY2UoJ2Vycm9yJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzcy5raWxsKCdTSUdLSUxMJyk7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3MgPSBudWxsIGFzIHVua25vd24gYXMgY2hpbGRQcm9jZXNzLkNoaWxkUHJvY2Vzc1dpdGhvdXROdWxsU3RyZWFtcztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAgICAgaWYgKCFmZm1wZWdJbmZvLm1ldGFkYXRhKSByZXR1cm4gJ0ZGbXBlZyc7XG5cbiAgICAgICAgcmV0dXJuIGZmbXBlZ0luZm8ubWV0YWRhdGE7XG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgZmluZEZGbXBlZyA9IEZGbXBlZy5sb2NhdGU7XG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOzs7QUNBQSwyQkFBeUI7QUFDekIsb0JBQXNDO0FBSXRDLElBQU0sb0JBQW9CLHdCQUFDLEdBQVksU0FBa0I7QUFDckQsTUFBSSxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBQUcsVUFBTSxJQUFJLFVBQVUsWUFBWSxPQUFPLEtBQUssT0FBTyxTQUFTLElBQUksbUJBQW1CLEdBQUc7QUFDdkgsU0FBTztBQUNYLEdBSDBCO0FBaUIxQixJQUFNLGFBQXlCO0FBQUEsRUFDM0IsU0FBUztBQUFBLEVBQ1QsVUFBVTtBQUFBLEVBQ1YsU0FBUztBQUFBLEVBQ1QsVUFBVTtBQUNkO0FBT0EsSUFBTSxZQUFZLFFBQVEsYUFBYTtBQUloQyxJQUFNLDBCQUE0QztBQUFBLEVBQ3JEO0FBQUEsSUFDSSxVQUFVO0FBQ04sYUFBTyxrQkFBa0IsUUFBUSxJQUFJLGFBQWEsS0FBSyxXQUFXO0FBQUEsSUFDdEU7QUFBQSxJQUNBLGFBQWE7QUFBQSxFQUNqQjtB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